"use strict";window.EC5=window.EC5||{},window.EC5.projectApps=window.EC5.projectApps||{},function(e){e.currentClientId="",e.getApps=function(){$.ajax({url:"",type:"GET",dataType:"json",data:{}}).done(function(e){$(".project-apps-list").html(e)}).fail(window.EC5.showError)},e.post=function(t,a,o){$.ajax({url:t,type:"POST",dataType:"json",data:a}).done(function(){o&&o(),e.getApps()}).fail(window.EC5.showError)}}(window.EC5.projectApps),$(document).ready(function(){var e=$(".project-apps");e.on("click",".pagination a",function(e){e.preventDefault(),window.EC5.projectApps.getApps()});var t=$("#ec5-form-project-apps");t.on("submit",function(e){e.preventDefault();var t=$(this).serialize(),a=$(this).attr("action");window.EC5.overlay.fadeIn(),window.EC5.projectApps.post(a,t,function(){$("#create-app").prop("disabled",!0),$("#modal-create-app").modal("hide"),window.EC5.toast.showSuccess("New App added."),setTimeout(function(){window.EC5.overlay.fadeOut()},500)})});var a=$(".project-apps-list");a.on("click","#delete-app",function(e){e.preventDefault(),$("#ec5-form-project-app-revoke").addClass("hidden"),$("#ec5-form-project-app-delete").removeClass("hidden"),window.EC5.projectApps.currentClientId=$(this).data("clientId")}),a.on("click","#revoke-app",function(e){e.preventDefault(),$("#ec5-form-project-app-delete").addClass("hidden"),$("#ec5-form-project-app-revoke").removeClass("hidden"),window.EC5.projectApps.currentClientId=$(this).data("clientId")});var o=$("#ec5-form-project-app-delete");o.on("submit",function(e){e.preventDefault();var t={client_id:window.EC5.projectApps.currentClientId},a=$(this).attr("action");window.EC5.overlay.fadeIn(),window.EC5.projectApps.post(a,t,function(){$("#create-app").prop("disabled",!1),$("#modal-app-delete").modal("hide"),window.EC5.toast.showSuccess("App deleted."),setTimeout(function(){window.EC5.overlay.fadeOut()},500)})});var n=$("#ec5-form-project-app-revoke");n.on("submit",function(e){e.preventDefault();var t={client_id:window.EC5.projectApps.currentClientId},a=$(this).attr("action");window.EC5.overlay.fadeIn(),window.EC5.projectApps.post(a,t,function(){$("#modal-app-delete").modal("hide"),window.EC5.toast.showSuccess("Access Token revoked."),setTimeout(function(){window.EC5.overlay.fadeOut()},500)})})}),window.EC5=window.EC5||{},window.EC5.projectCreate=window.EC5.projectCreate||{},function(e){e.doesProjectExist=function(e){var t=$(".page-create-project").find("#project-name-form-group-create");$.when($.get(e)).done(function(e){console.log(e.data),$("#project-loader").addClass("hidden"),e.data.exists?window.EC5.projectCreate.toggleGroupValidation(t,!1,"Project already exists"):window.EC5.projectCreate.toggleGroupValidation(t,!0)}).fail(function(){t.addClass("has-error")}).always(function(){$("#project-loader").addClass("hidden")})},e.toggleGroupValidation=function(e,t,a){t?(e.removeClass("has-error"),e.find(".form-control-feedback").not("#project-loader").addClass("hidden"),e.find(".text-danger").addClass("hidden"),e.find(".text-hint").removeClass("hidden")):(e.addClass("has-error"),e.find(".form-control-feedback").not("#project-loader").removeClass("hidden"),e.find(".text-danger").removeClass("hidden").text(a),e.find(".text-hint").addClass("hidden"))}}(window.EC5.projectCreate),$(document).ready(function(){if(0!==$(".page-create-project").length){var e=$("#project-loader");$(".page-create-project #project-name-create").keyup(function(t){var a,o=$(".page-create-project #project-name-form-group-create"),n=$(this),i=n.val(),r=/^[a-zA-Z0-9_ ]*$/;if(r.test(i)||""===i){if(window.EC5.projectCreate.toggleGroupValidation(o,!0),i.length>=3){var s=window.EC5.SITE_URL+"/api/internal/exists/"+i;e.removeClass("hidden"),clearTimeout(a),a=setTimeout(function(){window.EC5.projectCreate.doesProjectExist(s)},500)}}else e.addClass("hidden"),window.EC5.projectCreate.toggleGroupValidation(o,!1,"Please remove invalid chars")}),$(".page-create-project #form-name").keyup(function(e){var t=/^[\w\-\s]+$/,a=$(this),o=a.val(),n=$("#form-name-form-group");t.test(o)||""===o?window.EC5.projectCreate.toggleGroupValidation(n,!0):window.EC5.projectCreate.toggleGroupValidation(n,!1,"Please remove invalid chars")}),$(".page-create-project #small-description-form-group > input").keyup(function(e){var t=$("#small-description-form-group"),a=$(this),o=a.val();o.length>=15?window.EC5.projectCreate.toggleGroupValidation(t,!0):window.EC5.projectCreate.toggleGroupValidation(t,!1,"Must be at least 15 chars long")}),$(".page-create-project .create-project-form").on("submit",function(e){return this.checkValidity()?(window.EC5.overlay.fadeIn(),void $(this).find('button[type="submit"]').prop("disabled",!0)):(e.preventDefault(),window.EC5.overlay.fadeOut(),!1)}),$(".page-create-project #project-name-form-group-import").on("submit",function(e){return this.checkValidity()?(window.EC5.overlay.fadeIn(),void $(this).find('button[type="submit"]').prop("disabled",!0)):(e.preventDefault(),window.EC5.overlay.fadeOut(),!1)})}}),document.addEventListener("DOMContentLoaded",function(){function e(e){e.returnValue="ciao"}function t(a,n,i){$.when(window.EC5.projectUtils.postRequest(a,n)).done(function(){h+=_>u?u:_,o(h,_,v),$.get(window.EC5.SITE_URL+"/api/internal/counters/entries/"+i,function(o){try{o.data.counters.total>0?(_=o.data.counters.total,t(a,n,i)):(window.removeEventListener("beforeunload",e),window.location.href=p,window.EC5.toast.showSuccess("All Entries Deleted."))}catch(r){window.EC5.projectUtils.showErrors(r),l.modal("hide")}}).fail(function(e){window.EC5.projectUtils.showErrors(e),l.modal("hide")})}).fail(function(e){window.EC5.projectUtils.showErrors(e),l.modal("hide")})}function a(e,o,i){$.when(window.EC5.projectUtils.postRequest(e,o)).done(function(e){if(e&&e.data&&"ec5_407"!==e.data.code)return window.EC5.projectUtils.showErrors(e),void l.modal("hide");var r=e.data.deleted;r>0&&(E+=r),g=C-E,n(E,g,C),g<=0?t(f,o,i):a(m,o,i)}).fail(function(e){window.EC5.projectUtils.showErrors(e),l.modal("hide")})}function o(e,t,a){if(0===t)return d.find(".counter-percentage").text("100%"),d.find(".counter-deleted").text(a),j.attr("aria-valuenow",0),void j.css("width","0%");var o=Math.min(e,a),n=(o/a*50).toFixed(1),i=(50*(1-o/a)).toFixed(1);j.attr("aria-valuenow",i),j.css("width",i+"%"),d.find(".counter-percentage").text(2*n+"%"),d.find(".counter-deleted").text(o),d.find(".counter-total").text(a)}function n(e,t,a){if(0===t)return c.find(".counter-percentage").text("100%"),c.find(".counter-deleted").text(a),b.attr("aria-valuenow",0),void b.css("width","0%");var o=Math.min(e,a),n=(o/a*50).toFixed(1),i=(50*(1-o/a)).toFixed(1);b.attr("aria-valuenow",i),b.css("width",i+"%"),c.find(".counter-percentage").text(2*n+"%"),c.find(".counter-deleted").text(o),c.find(".counter-total").text(a)}var i=$(".page-entries-deletion");if(i.length>0){var r=i.find(".project-name").text(),s=$(".delete-entries-wrapper"),d=$(".progress-entries"),c=$(".progress-media"),l=$("#modal-deletion"),p=$(".btn-cancel-deletion").attr("href"),u=parseInt(i.data("chunk-size-entries"),10),w=window.EC5.projectUtils.slugify(r.trim()),f=window.EC5.SITE_URL+"/api/internal/deletion/entries/"+w,m=window.EC5.SITE_URL+"/api/internal/deletion/media/"+w;s.on("click",".btn-delete-entries",function(t){r.trim()!==$("#project-name").val().trim()&&(t.preventDefault(),window.EC5.projectUtils.showErrors("Project name incorrect. Please try again."));var o={data:{"project-name":r.trim()}};l.modal({backdrop:"static",keyboard:!1},"show"),window.addEventListener("beforeunload",e),$.get(window.EC5.SITE_URL+"/api/internal/counters/media/"+w,function(e){C=e.data.counters.total,c.find(".spinner").addClass("hidden").fadeOut(function(){c.find(".counter-total").text(C).removeClass("hidden").fadeIn()}),a(m,o,w)})}),s.on("keyup","#project-name",function(e){e.preventDefault(),r.replace(/\s+/g," ")===$(this).val()?$(".btn-delete-entries").prop("disabled",!1):$(".btn-delete-entries").prop("disabled",!0)});var h=0,E=0,v=parseInt(s.data("total-entries")),C=parseInt(s.data("total-media")),_=v,g=C,j=$(".progress-bar__modal-deletion__entries"),b=$(".progress-bar__modal-deletion__media");d.find(".counter-total").text(_),c.find(".counter-total").text(g)}}),$(document).ready(function(){if($(".page-project-delete").length>0){var e=$("h3[data-project-name]").attr("data-project-name"),t=$(".delete-project"),a=$("#modal-deletion");t.submit(function(t){e.replace(/\s+/g," ")!==$("#project-name").val()&&t.preventDefault(),a.modal({backdrop:"static",keyboard:!1},"show")}),t.on("keyup","#project-name",function(t){t.preventDefault(),e.replace(/\s+/g," ")===$(this).val()?$(".submit-delete").prop("disabled",!1):$(".submit-delete").prop("disabled",!0)})}}),window.EC5=window.EC5||{},window.EC5.projectDetails=window.EC5.projectDetails||{},function(e){e.statusPairs={trashed:["restore","delete"],locked:["unlock"],active:["trashed","locked"]},e.currentSettingsValue=function(e){return window.EC5.projectDetails.parameters[e]||""},e.updateSettings=function(t){var a=e.currentSettingsValue(t),o=$(".settings-"+t);if("status"===t){var n=e.statusPairs[a]?e.statusPairs[a]:[];o.each(function(e,t){$(t).data("value")===a?$(this).addClass("btn-action"):$(this).removeClass("btn-action"),n.indexOf($(t).data("value"))!==-1||$(t).data("value")===a?$(this).removeClass("ec5-hide-block"):$(this).addClass("ec5-hide-block")})}o.each(function(e,t){$(t).data("value")===a?$(this).addClass("btn-action"):$(this).removeClass("btn-action")})},e.update=function(t,a){var o=window.EC5.SITE_URL+"/myprojects/"+window.EC5.projectDetails.parameters.slug+"/settings/"+t,n={};n[t]=a,$.when(window.EC5.projectUtils.postRequest(o,n)).done(function(a){try{$.each(a.data,function(e,t){window.EC5.projectDetails.parameters[e]=t}),e.updateSettings(t),window.EC5.toast.showSuccess("Settings updated.")}catch(o){window.EC5.projectUtils.showErrors(o)}}).fail(function(e){window.EC5.overlay.fadeOut(),window.EC5.projectUtils.showErrors(e)}).always(function(){window.EC5.overlay.fadeOut()})}}(window.EC5.projectDetails),$(document).ready(function(){function e(){var e,t,a,o=n.find(".count-photo").data("photo-files"),r=n.find(".count-audio").data("audio-files"),s=n.find(".count-video").data("video-files"),d=n.find(".size-photo").data("photo-bytes"),c=n.find(".size-audio").data("audio-bytes"),l=n.find(".size-video").data("video-bytes"),p=n.find(".size-total").data("total-bytes"),u=n.find(".count-total").data("total-files");0===p?e=t=a=0:(e=(d/p*100).toFixed(1),t=(c/p*100).toFixed(1),a=(l/p*100).toFixed(1)),n.find('.progress-bar[data-type="photo"]').css("width",e+"%"),n.find('.progress-bar[data-type="audio"]').css("width",t+"%"),p>0&&(a=(100-parseFloat(e)-parseFloat(t)).toFixed(1)),n.find('.progress-bar[data-type="video"]').css("width",a+"%"),n.find(".count-photo").text(o),n.find(".count-audio").text(r),n.find(".count-video").text(s),n.find(".count-total").text(u),n.find(".size-photo").text(window.EC5.common.formatBytes(d,2)),n.find(".size-audio").text(window.EC5.common.formatBytes(c,2)),n.find(".size-video").text(window.EC5.common.formatBytes(l,2)),n.find(".size-total").text(window.EC5.common.formatBytes(p,2)),n.find(".ratio-photo").text(e+"%"),n.find(".ratio-audio").text(t+"%"),n.find(".ratio-video").text(a+"%"),0===p?n.find(".ratio-total").text("0%"):n.find(".ratio-total").text("100%"),n.find(".loader").fadeOut(function(){n.find(".media-stats").removeClass("hidden").fadeIn()}),i.find(".loader").fadeOut(function(){i.find(".quota-stats").removeClass("hidden").fadeIn()})}function t(){window.EC5.overlay.fadeIn(),n.find(".media-stats").addClass("hidden").hide(),n.find(".loader").fadeIn(),i.find(".quota-stats").addClass("hidden").hide(),i.find(".loader").fadeIn(),$.get(window.EC5.SITE_URL+"/api/internal/counters/media/"+s).done(function(e){var t,a,o,i=e.data.counters,s=e.data.sizes,d=s.total_bytes;0===d?t=a=o=0:(t=(s.photo_bytes/d*100).toFixed(1),a=(s.audio_bytes/d*100).toFixed(1),o=(s.video_bytes/d*100).toFixed(1)),n.find('.progress-bar[data-type="photo"]').css("width",t+"%"),n.find('.progress-bar[data-type="audio"]').css("width",a+"%"),d>0&&(o=(100-parseFloat(t)-parseFloat(a)).toFixed(1)),n.find('.progress-bar[data-type="video"]').css("width",o+"%"),n.find(".count-photo").text(i.photo),n.find(".count-audio").text(i.audio),n.find(".count-video").text(i.video),n.find(".count-total").text(i.total),n.find(".size-photo").text(window.EC5.common.formatBytes(s.photo_bytes,2)),n.find(".size-audio").text(window.EC5.common.formatBytes(s.audio_bytes,2)),n.find(".size-video").text(window.EC5.common.formatBytes(s.video_bytes,2)),n.find(".size-total").text(window.EC5.common.formatBytes(s.total_bytes,2)),n.find(".ratio-photo").text(t+"%"),n.find(".ratio-audio").text(a+"%"),n.find(".ratio-video").text(o+"%"),0===d?n.find(".ratio-total").text("0%"):n.find(".ratio-total").text("100%"),r.find(".bytes-updated-at span").text(e.data.updated_at_human_readable)}).fail(function(){n.find(".loader").text("Error loading data"),i.find(".loader").text("Error loading data")}).always(function(){n.find(".loader").fadeOut(function(){n.find(".media-stats").removeClass("hidden").fadeIn()}),i.find(".loader").fadeOut(function(){i.find(".quota-stats").removeClass("hidden").fadeIn()}),window.EC5.overlay.fadeOut()})}if(0===$(".page-project-details").length)return!1;$('[data-toggle="tooltip"]').tooltip();var a=$(".js-project-details");if($(document).on("change",":file",function(){var e=$(this),t=e.get(0).files?e.get(0).files.length:1,a=e.val().replace(/\\/g,"/").replace(/.*\//,"");e.trigger("fileselect",[t,a])}),$(":file").on("fileselect",function(e,t,a){var o=$(this).parents(".input-group").find(":text"),n=t>1?t+" files selected":a;o.length&&o.val("    "+n)}),window.EC5.projectDetails.parameters={status:a.attr("data-js-status"),access:a.attr("data-js-access"),visibility:a.attr("data-js-visibility"),logo_url:a.attr("data-js-logo_url"),category:a.attr("data-js-category"),slug:a.attr("data-js-slug"),app_link_visibility:a.attr("data-js-app_link_visibility")},$(".deeplink-btn-panel").length>0){var o=$("#qrcode");new window.QRCode("qrcode",{text:o.data("url"),width:1024,height:1024,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.H});$("#qrcode-download").on("click",function(){var e=o.find("img");$(this).attr("href",e.attr("src"))})}$(".btn-settings-submit").on("click",function(){var e=$(this),t=e.attr("data-setting-type"),a=e.attr("data-value");a!==window.EC5.projectDetails.currentSettingsValue(t)&&(window.EC5.overlay.fadeIn(),window.EC5.projectDetails.update(t,a))}),$(["access","status","visibility","app_link_visibility"]).each(function(e,t){window.EC5.projectDetails.updateSettings(t)}),$("#project-category").on("change",function(){var e="category",t=$(this).val();t!==window.EC5.projectDetails.currentSettingsValue(e)&&(window.EC5.overlay.fadeIn(),window.EC5.projectDetails.update(e,t))}),$(".project-details__edit").on("click",function(){var e=$(this).parents(".panel");switch(window.EC5.overlay.fadeIn(),e.hide(),e.attr("id")){case"details-view":$("#details-edit").fadeIn(function(){window.EC5.overlay.fadeOut()});break;case"details-edit":$("#details-view").fadeIn(function(){window.EC5.overlay.fadeOut()})}}),$(".project-homepage-url .copy-btn").on("click",function(){var e=$(this);console.log(e.parent().find("a").text()),navigator.clipboard.writeText(e.parent().find("a").text()).then(function(){e.tooltip("show"),window.setTimeout(function(){e.tooltip("hide")},1500)},function(){})}),$(".deeplink-copy-btn").on("click",function(){var e=$(this),t=e.data("url");console.log(t),navigator.clipboard.writeText(t).then(function(){e.find("i").tooltip("show"),window.setTimeout(function(){e.find("i").tooltip("hide")},1500)},function(){})});var n=$(".counter-media"),i=$(".counter-quota"),r=$(".panel-quota"),s=n.data("project-slug"),d=$(".btn-refresh-media-overview");d.on("click",function(){t()}),e()}),$(document).ready(function(){if($(".page-project-home").length>0){var e=$("#qrcode");new window.QRCode("qrcode",{text:e.data("url"),width:200,height:200,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.H})}}),$(document).ready(function(){if($(".page-project-leave").length>0){var e=$("h3[data-project-name]").attr("data-project-name"),t=$(".leave-project"),a=$("#modal-leave");t.submit(function(t){e.replace(/\s+/g," ")!==$("#project-name").val()&&t.preventDefault(),a.modal({backdrop:"static",keyboard:!1},"show")}),t.on("keyup","#project-name",function(t){t.preventDefault(),e.replace(/\s+/g," ")===$(this).val()?$(".submit-leave").prop("disabled",!1):$(".submit-leave").prop("disabled",!0)})}}),$(document).ready(function(){var e=$(".manage-entries-limits__table"),t=$(".page-manage-entries #limits-form"),a=$(".page-manage-entries .limits-form__update-btn"),o=$(".page-manage-entries .bulk-upload-btns"),n=o.data("project-slug"),i=window.EC5.SITE_URL+"/api/internal/can-bulk-upload/"+n;e.on("change","td input:checkbox",function(){var e=$(this).parents("td").next().find("input.input__limit-to");this.checked?e.prop("disabled",!1):(e.val(""),e.prop("disabled",!0))}),a.on("click",function(){window.EC5.toast.clear(),window.EC5.overlay.fadeIn(),t.find(".input__set-limit").each(function(){var e=$(this),t=e.parents("td").next().find("input.input__limit-to"),a=t.parent(),o=a.find(".form-control-feedback");o.addClass("hidden"),a.removeClass("has-error has-feedback")});var e=!0;t.find(".input__set-limit:checked").each(function(){var t=$(this),a=t.parents("td").next().find("input.input__limit-to"),o=a.parent(),n=o.find(".form-control-feedback");""===a.val()&&(o.addClass("has-error has-feedback"),n.removeClass("hidden"),e=!1)}),e?t.submit():(window.EC5.overlay.fadeOut(),window.EC5.toast.showError("Required fields missing!"))}),t.on("submit",function(e){e.preventDefault(),$.ajax({url:"",type:"POST",dataType:"json",data:$(this).serializeArray()}).done(function(){window.EC5.toast.showSuccess("Updated.")}).fail(function(e){if(e.responseJSON&&e.responseJSON.errors&&e.responseJSON.errors.length>0){var t;for(t=0;t<e.responseJSON.errors.length;t++)window.EC5.toast.showError(e.responseJSON.errors[t].title)}}).always(function(){window.EC5.overlay.fadeOut()})}),o.on("click",".btn",function(e){var t=$(this);window.EC5.overlay.fadeIn(),window.EC5.projectUtils.postRequest(i,{can_bulk_upload:$(this).data("bulk-upload")}).done(function(){o.find(".btn-action").removeClass("btn-action"),t.addClass("btn-action"),window.EC5.overlay.fadeOut(),window.EC5.toast.showSuccess("Settings updated.")}).fail(function(e){if(e.responseJSON.errors&&e.responseJSON.errors.length>0)for(var t=0;t<e.responseJSON.errors.length;t++)window.EC5.toast.showError(e.responseJSON.errors[t].title);window.EC5.overlay.fadeOut()})})}),$(document).ready(function(){if(0!==$(".page-manage-users").length){var e,t=$(".manage-project-users"),a="#creator",o=window.EC5.project_users.config;window.EC5.overlay.fadeIn(),$('a[data-toggle="tab"]').on("show.bs.tab",function(e){window.EC5.overlay.fadeIn();var t=$(e.target).attr("href");a="page-"+t.substring(1),$(".manage-project-users__"+a).html(""),$(".user-search-heading").hide(),$.when(window.EC5.project_users.getProjectUsers(a,1)).then(function(e){$(".manage-project-users__"+a).hide().html(e).fadeIn(o.consts.ANIMATION_FAST)},function(e){e.responseJSON?window.EC5.toast.showError(e.responseJSON.errors[0].title):window.EC5.toast.showError(e)}).always(function(){window.EC5.overlay.fadeOut()})}),$.when(window.EC5.project_users.getProjectUsers("page-creator").then(function(e){$(".manage-project-users__"+a).remove().html(e),window.EC5.overlay.fadeOut()},function(e){window.EC5.overlay.fadeOut()})),$(".page-manage-users .tab-content .panel-body").off().on("click",".manage-project-users__switch-role",function(){var e=$(this).data("project-slug"),t=$(this).data("user-role"),a=$(this).data("user-email"),n=$("#ec5SwitchUserRole");n.find(".user-email strong").text(a);var i=$.map(o.consts.ROLES,function(e){return e});$(i).each(function(e,t){n.find(".role-"+t).show()}),n.find(".role-"+t).hide(),n.find(".switch-role-confirm").attr("disabled",!0),n.find("input:radio").prop("checked",!1),n.modal("show"),n.on("shown.bs.modal",function(o){var i=null;n.find(".users__pick-role .radio label").off().on("click",function(){i=n.find(".users__pick-role").find(".radio input:checked").val(),n.find(".switch-role-confirm").attr("disabled",!1)}),n.find(".switch-role-confirm").off().on("click",function(){return null!==i&&(!(!e||!a)&&(window.EC5.overlay.fadeIn(),void $.when(window.EC5.project_users.switchUserRole(e,a,t,i)).done(function(e){var a="page-"+t;$.when(window.EC5.project_users.getProjectUsers(a,1).then(function(t){$(".manage-project-users__"+a).html(t),n.modal("hide"),window.EC5.toast.showSuccess(e.data.message),window.EC5.overlay.fadeOut()},function(e){window.EC5.overlay.fadeOut(),e.responseJSON?window.EC5.toast.showError(e.responseJSON.errors[0].title):window.EC5.toast.showError(e),n.modal("hide")}))}).fail(function(e){console.log(e),window.EC5.overlay.fadeOut(),e.responseJSON?window.EC5.toast.showError(e.responseJSON.errors[0].title):window.EC5.toast.showError(e),n.modal("hide")})))})})}),t.on("click",".pagination a",function(e){e.preventDefault(),window.EC5.overlay.fadeIn();var t=$(this).closest(".manage-project-users"),a=t.data("page-name"),o=t.find(".manage-project-users__user-search").val();$.when(window.EC5.project_users.getProjectUsers(a,$(this).attr("href").split("=")[1],o).then(function(e){$(".manage-project-users__"+a).html(e),window.EC5.overlay.fadeOut()},function(){window.EC5.overlay.fadeOut()}))}),t.on("keyup",".manage-project-users__user-search",function(t){var a=this.value;if(a.length>=0||13===t.keyCode){window.EC5.overlay.fadeIn();var o=$(this).closest(".manage-project-users"),n=o.data("page-name"),i=200;clearTimeout(e),e=setTimeout(function(){$.when(window.EC5.project_users.getProjectUsers(n,1,a).then(function(e){$(".manage-project-users__"+n).html(e),window.EC5.overlay.fadeOut()},function(){window.EC5.overlay.fadeOut()}))},i)}}),t.on("click",".manage-project-users__reset",function(e){window.EC5.overlay.fadeIn(),e.preventDefault();var t=$(this).closest(".manage-project-users"),a=t.data("page-name");$(".manage-project-users__user-search").val(""),$.when(window.EC5.project_users.getProjectUsers(a,1).then(function(e){$(".manage-project-users__"+a).html(e),window.EC5.overlay.fadeOut()},function(){window.EC5.overlay.fadeOut()}))}),t.on("submit",".manage-project-users__table__remove-form",function(e){e.preventDefault();var t=$(this).serializeArray(),a=$(this).attr("action"),o=$(this).closest(".manage-project-users"),n=o.data("page-name"),i=o.find(".pagination .active span").html(),r=o.find(".manage-project-users__user-search").val();window.EC5.project_users.removeUserProjectRole(a,t,n,i,r)}),$(".manage-project-users__existing-user-add-form").on("submit",function(e){e.preventDefault();var t=$(this).serializeArray(),a=$(this).attr("action"),o="page-creator";t.forEach(function(e){if("role"===e.name)return o=e.value?"page-"+e.value:"page-creator",!1}),window.EC5.project_users.addUserProjectRole(a,t,o,function(){$("#ec5ModalExistingUser").find("input[type=email]").val(""),$("#ec5ModalExistingUser").modal("hide")})}),$(".manage-project-users__new-user-add-form").on("submit",function(e){e.preventDefault();var t=$(this).serializeArray(),a=$(".manage-project-users__existing-user-add-form").serializeArray(),o=t.concat(a),n=$(this).attr("action"),i=o[2]&&o[2].value?"page-"+o[2].value:"page-creator";window.EC5.project_users.addUserProjectRole(n,o,i,function(){$("#ec5ModalExistingUser").find("input[type=email]").val(""),$("#ec5ModalExistingUser").modal("hide"),$("#ec5ModalNewUser").modal("hide")})}),$(".manage-user-more__import-users").off().on("click",function(){var e=$(this);if(!window.EC5.project_users.isOpeningFileBrowser){var t=e.find(".manage-user-more__import-users__input-file");window.EC5.project_users.isOpeningFileBrowser=!0,t.off("change").on("change",function(){window.EC5.project_users.pickCSVFile(this.files),$(this).val(null)}),e.find(".manage-user-more__import-users__input-file").trigger("click")}window.setTimeout(function(){window.EC5.project_users.isOpeningFileBrowser=!1},3e3)}),$(".manage-user-more__export-users").off().on("click",function(){var e=$(this).find("a").data("project-slug");window.EC5.overlay.fadeIn(),$.when(window.EC5.project_users.exportUsersToCSV(e)).then(function(){window.EC5.overlay.fadeOut()},function(e){e.responseJSON?window.EC5.toast.showError(e.responseJSON.errors[0].title):window.EC5.toast.showError(e),window.EC5.overlay.fadeOut()})}),$(".manage-project-users__delete-by-role").off().on("click",function(){var e=$(this).data("project-slug"),t=$(this).data("role");window.EC5.overlay.fadeIn(),$.when(window.EC5.project_users.removeUsersByRole(e,t)).then(function(e){window.EC5.toast.showSuccess(e.data.message),$.when(window.EC5.project_users.getProjectUsers(a,1).then(function(e){$(".manage-project-users__"+a).html(e),window.EC5.overlay.fadeOut()},function(){window.EC5.overlay.fadeOut()}))},function(e){window.EC5.overlay.fadeOut(),e.responseJSON?window.EC5.toast.showError(e.responseJSON.errors[0].title):window.EC5.toast.showError(e)})})}}),window.EC5=window.EC5||{},$(document).ready(function(){var e=4,t=$(".page-mapping-data"),a=t.data("url");0!==t.length&&($(".form-list-selection").on("click","li",function(){var e=$(this),t=$(e).data("form-ref"),a=$(".map-data__tabs li.active").data("map-index"),o=$("#map-data-tabcontent-"+a+" .panel-body");e.parents(".form-list-selection").find(".dropdown-toggle .form-list-selection__form-name").text(e.text()),o.find(".table-responsive").fadeOut().addClass("hidden"),o.find('[data-form-ref="'+t+'"]').hide().removeClass("hidden").fadeIn()}),$(".map-data--actions__btns").on("click",'[data-toggle="push"]',function(){var e=$(this),t=e.data("action"),o=$(".map-data__tabs li.active"),n=$(".map-data__tabs li").not(".active").not(".map-data__tabs__add-form"),i=o.data("map-index"),r=o.data("map-name");switch(console.log(t),t){case"make-default":window.EC5.mapping.makeDefault(a,t,i,r,o,n);break;case"update":window.EC5.mapping.update(a,t,i,r)}}),$("#modal__mapping-data").on("show.bs.modal",function(t){var o=$(t.relatedTarget),n=o.data("action"),i=$(this),r=o.data("trans"),s=i.find(".map-data__modal__save-btn"),d=$(".map-data__tabs li.active"),c=!d.find(".map-data__default-pin").hasClass("invisible"),l=d.data("map-index"),p=d.data("map-name"),u=$(".page-mapping-data .tab-content");switch(i.find(".modal-title").text(r),n){case"delete":window.EC5.mapping["delete"](a,n,l,p,d,i,s,c,u);break;case"rename":window.EC5.mapping.rename(a,n,l,p,d,i,s);break;case"add-mapping":window.EC5.mapping.addMapping(a,i,s,e,u,u)}}))}),window.EC5=window.EC5||{},window.EC5.projectUtils=window.EC5.projectUtils||{},function(e){e.postRequest=function(e,t){return $.ajax({url:e,contentType:"application/vnd.api+json",data:JSON.stringify(t),dataType:"json",method:"POST",crossDomain:!0})},e.showErrors=function(e){var t="";e.responseJSON?$(e.responseJSON.errors).each(function(e,a){t+=a.title+"\n"}):t+="Unknown error\n",window.EC5.toast.showError(t)},e.slugify=function(e){return e.toLowerCase().replace(/\s+/g,"-")}}(window.EC5.projectUtils),window.EC5=window.EC5||{},window.EC5.project_users=window.EC5.project_users||{},function(e){e.addUserProjectRole=function(t,a,o,n){var i;$.ajax({url:t,type:"POST",dataType:"json",data:a}).done(function(t){window.EC5.toast.showSuccess(t.data.message),$.when(e.getProjectUsers(o,1)).then(function(e){var t=o.replace("page-","");$(".manage-project-users__"+o).html(e),$(".page-manage-users .nav-tabs li").find("a."+t+"-tab-btn").trigger("click"),n&&n()})}).fail(function(e){var t="ec5_90";if(e.responseJSON.errors&&e.responseJSON.errors.length>0)for(i=0;i<e.responseJSON.errors.length;i++)e.responseJSON.errors[i].code===t?$("#ec5ModalNewUser").modal():window.EC5.toast.showError(e.responseJSON.errors[i].title)})}}(window.EC5.project_users),window.EC5=window.EC5||{},window.EC5.project_users=window.EC5.project_users||{},function(e){e.config={messages:{error:{CSV_FILE_INVALID:"CSV file is invalid",INVALID_EMAILS:"Invalid emails",BROWSER_NOT_SUPPORTED:"Browser not supported"},success:{USERS_IMPORTED:"Users added to the project"},warning:{SOME_USERS_NOT_IMPORTED:"Some users could not be imported"}},consts:{CSV_FILE_EXTENSION:"csv",ANIMATION_FAST:200,ANIMATION_NORMAL:500,ROLES:{CREATOR:"creator",MANAGER:"manager",CURATOR:"curator",COLLECTOR:"collector",VIEWER:"viewer"}},errorCodes:{userDoesntExist:"ec5_90",importerDoesNotHavePermission:"ec5_91",invalidValue:"ec5_29",invalidEmailAddress:"ec5_42",creatorEmailAddress:"ec5_217",managerEmailAddress:"ec5_344"},invalidEmailAddresses:[]}}(window.EC5.project_users),window.EC5=window.EC5||{},window.EC5.project_users=window.EC5.project_users||{},function(e){e.exportUsersToCSV=function(e){var t=this,a=t.config,o=new $.Deferred,n=window.EC5.SITE_URL+"/api/internal/project-users/"+e;return $.ajax({url:n,type:"GET",dataType:"json"}).done(function(t){var n={all:[],creators:[],managers:[],curators:[],collectors:[],viewers:[]},i={all:"",creators:"",managers:"",curators:"",collectors:"",viewers:""};$(t.data).each(function(e,t){switch(n.all.push(t),t.role){case"creator":n.creators.push(t);break;case"manager":n.managers.push(t);break;case"curator":n.curators.push(t);break;case"collector":n.collectors.push(t);break;case"viewer":n.viewers.push(t)}}),$.each(n,function(e){i[e]=Papa.unparse({data:n[e]},{quotes:!1,quoteChar:"",delimiter:",",header:!0,newline:"\r\n"})});var r=new JSZip;$.each(i,function(e,t){r.file(e+".csv",t)}),r.generateAsync({type:"blob"}).then(function(t){try{saveAs(t,e+"_users.zip"),o.resolve()}catch(n){console.log(n),o.reject(a.messages.error.BROWSER_NOT_SUPPORTED)}})}).fail(function(e){o.reject(e)}),o.promise()},e.getTotalsByRole=function(e){var t=new $.Deferred,a=window.EC5.SITE_URL+"/api/internal/project-users/"+e;return $.ajax({url:a,type:"GET",dataType:"json"}).done(function(e){var a={creator:0,manager:0,curator:0,collector:0,viewer:0};$(e.data).each(function(e,t){a[t.role]++}),t.resolve(a)}).fail(function(e){t.reject(e)}),t.promise()}}(window.EC5.project_users),window.EC5=window.EC5||{},window.EC5.project_users=window.EC5.project_users||{},function(e){e.getProjectUsers=function(e,t,a){var o=new $.Deferred,n={};t="undefined"!=typeof t?t:1,a="undefined"!=typeof a?a:"",n[e]=t,n.search=a;var i=$.ajax({url:"",type:"GET",dataType:"json",data:n}),r=window.EC5.project_users.updateRoleCounters();return $.when(i,r).then(function(e){o.resolve(e[0])}).fail(function(e){o.reject(e[0])}),o.promise()}}(window.EC5.project_users),window.EC5=window.EC5||{},window.EC5.project_users=window.EC5.project_users||{},function(e){function t(e){var t=/^([a-z\d!#$%&'*+\-\/=?^_`{|}~\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+(\.[a-z\d!#$%&'*+\-\/=?^_`{|}~\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+)*|"((([ \t]*\r\n)?[ \t]+)?([\x01-\x08\x0b\x0c\x0e-\x1f\x7f\x21\x23-\x5b\x5d-\x7e\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]|\\[\x01-\x09\x0b\x0c\x0d-\x7f\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))*(([ \t]*\r\n)?[ \t]+)?")@(([a-z\d\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]|[a-z\d\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF][a-z\d\-._~\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]*[a-z\d\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])\.)+([a-z\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]|[a-z\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF][a-z\d\-._~\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]*[a-z\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])\.?$/i;return t.test(e)}e.importUsersByEmail=function(e){var a=[],o=e.selectedHeaderIndex,n=e.importedJson,i=n.meta.fields,r=e.doesFirstRowContainsHeaders,s=e.selectedUserRole,d=e.postURL,c=new $.Deferred,l=window.EC5.project_users.config;if(l.invalidEmailAddresses=[],null===o)return!1;if(!r){var p={};p[n.meta.fields[o]]=n.meta.fields[o],n.data.unshift(p)}$(n.data).each(function(e,n){var r=n[i[o]];""!==r.trim()&&(t(r)?a.push(r):l.invalidEmailAddresses.push(r))});var u={role:s,emails:$.unique(a).slice(0,100)};return $.ajax({
url:d,type:"POST",dataType:"json",data:u}).done(function(e){c.resolve(e)}).fail(function(e){c.reject(e)}),c.promise()}}(window.EC5.project_users),window.EC5=window.EC5||{},window.EC5.project_users=window.EC5.project_users||{},function(e){e.pickCSVFile=function(e){function t(e){var t="";return e.responseJSON?$.each(e.responseJSON.errors,function(e,a){t+=a.title+"\n"}):t=e,t}var a,o,n=this,i=e[0],r=n.config;if(window.EC5.overlay.fadeIn(),n.isOpeningFileBrowser=!1,!i)return window.EC5.overlay.fadeOut(r.consts.ANIMATION_FAST),void window.EC5.toast.showError(r.messages.error.CSV_FILE_INVALID);if(a=i.name.split("."),o=a[a.length-1],o!==r.consts.CSV_FILE_EXTENSION)return window.EC5.overlay.fadeOut(r.consts.ANIMATION_FAST),void window.EC5.toast.showError(r.messages.error.CSV_FILE_INVALID);var s=new FileReader;s.onload=function(e){var a=e.target.result,o=Papa.parse(a,{header:!0,delimiter:",",skipEmptyLines:"greedy"}),i=o.meta.fields,s=$("#ec5ModalImportUsers");return 0===o.data.length?(window.EC5.overlay.fadeOut(r.consts.ANIMATION_FAST),void window.EC5.toast.showError(r.messages.error.CSV_FILE_INVALID)):(s.modal(),s.off().on("shown.bs.modal",function(){var e,a,d,c=s.find(".users-column-picker"),l="",p=null,u=s.data("post-url");c.find(".btn").html('Pick column <span class="caret"></span>'),c.find(".btn").val(""),s.find(".users__first-row-headers input").prop("checked",!0),s.find(".users__pick-role input#collector").prop("checked",!0),s.find(".users-perform-import").attr("disabled",!0),window.EC5.overlay.fadeOut(r.consts.ANIMATION_FAST),$(i).each(function(e,t){l+="<li>",l+='<a href="#">'+t.trunc(25)+"</a>",l+="</li>"}),c.find(".dropdown-menu").empty().append(l),c.find(".dropdown-menu li").off().on("click",function(){$(this).parents(".users-column-picker").find(".btn").html($(this).text()+' <span class="caret"></span>'),$(this).parents(".users-column-picker").find(".btn").val($(this).data("value")),p=$(this).index(),s.find(".users-perform-import").attr("disabled",!1)}),$(".users-perform-import").off().on("click",function(){return null!==p&&(window.EC5.overlay.fadeIn(),a=s.find(".users__first-row-headers").find(".checkbox input").is(":checked"),d=s.find(".users__pick-role").find(".radio input:checked").val(),e={doesFirstRowContainsHeaders:a,selectedUserRole:d,importedJson:o,selectedHeaderIndex:p,postURL:u},void window.setTimeout(function(){console.log("imported"),$.when(n.importUsersByEmail(e)).then(function(e){var t="page-"+d;$.when(window.EC5.project_users.getProjectUsers(t,1,"").then(function(e){$(".manage-project-users__"+t).html(e),$(".page-manage-users .nav-tabs li").find("a."+d+"-tab-btn").trigger("click"),window.EC5.overlay.fadeOut(),$("#ec5ModalImportUsers").modal("hide"),r.invalidEmailAddresses.length>0?(window.EC5.toast.showWarning(r.messages.warning.SOME_USERS_NOT_IMPORTED),window.EC5.toast.showError(r.messages.error.INVALID_EMAILS+": \n"+r.invalidEmailAddresses.join("\n"))):window.EC5.toast.showSuccess(r.messages.success.USERS_IMPORTED)},function(){window.EC5.overlay.fadeOut()}))},function(e){var a="page-"+d;$.when(window.EC5.project_users.getProjectUsers(a,1,"").then(function(o){$(".manage-project-users__"+a).html(o),$(".page-manage-users .nav-tabs li").find("a."+d+"-tab-btn").trigger("click"),window.EC5.overlay.fadeOut(),$("#ec5ModalImportUsers").modal("hide"),window.EC5.toast.showError(t(e)),r.invalidEmailAddresses.length>0&&(window.EC5.toast.showWarning(r.messages.warning.SOME_USERS_NOT_IMPORTED),window.EC5.toast.showError(r.messages.error.INVALID_EMAILS+": \n"+r.invalidEmailAddresses.join("\n")))},function(){window.EC5.overlay.fadeOut()}))})},1e3))})}),void s.find('button[data-dismiss="modal"]').one("click",function(){s.modal("hide")}))},s.readAsText(i)}}(window.EC5.project_users),window.EC5=window.EC5||{},window.EC5.project_users=window.EC5.project_users||{},function(e){e.removeUserProjectRole=function(t,a,o,n,i){var r,s=window.EC5.project_users.config,d=a.length,c={};for(window.EC5.overlay.fadeIn(),r=0;r<d;r++)c[a[r].name]=a[r].value;var l=c["total-users"]-1;0===l&&(n-=1),$.ajax({url:t,type:"POST",dataType:"json",data:a,page:n}).done(function(t){$.when(e.getProjectUsers(o,n,i)).then(function(e){$(".manage-project-users__"+o).html(e),window.setTimeout(function(){window.EC5.toast.showSuccess(t.data.message),window.EC5.overlay.fadeOut()},s.consts.ANIMATION_NORMAL)},function(e){window.setTimeout(function(){if(e.responseJSON.errors&&e.responseJSON.errors.length>0)for(r=0;r<e.responseJSON.errors.length;r++)window.EC5.toast.showError(e.responseJSON.errors[r].title);window.EC5.overlay.fadeOut()},s.consts.ANIMATION_NORMAL)})}).fail(function(e){window.setTimeout(function(){if(e.responseJSON.errors&&e.responseJSON.errors.length>0)for(r=0;r<e.responseJSON.errors.length;r++)window.EC5.toast.showError(e.responseJSON.errors[r].title);window.EC5.overlay.fadeOut()},s.consts.ANIMATION_NORMAL)})}}(window.EC5.project_users),window.EC5=window.EC5||{},window.EC5.project_users=window.EC5.project_users||{},function(e){e.removeUsersByRole=function(e,t){var a=new $.Deferred,o=window.EC5.SITE_URL+"/api/internal/project-users/"+e+"/remove-by-role";return $.ajax({url:o,type:"POST",dataType:"json",data:{role:t}}).done(function(e){var o="page-"+t;$(".manage-project-users__"+o).html(""),a.resolve(e)}).fail(function(e){a.reject(e)}),a.promise()}}(window.EC5.project_users),window.EC5=window.EC5||{},window.EC5.project_users=window.EC5.project_users||{},function(e){e.switchUserRole=function(e,t,a,o){var n=window.EC5.SITE_URL+"/api/internal/project-users/"+e+"/switch-role",i=window.EC5.project_users.config,r=$.map(i.consts.ROLES,function(e){return e}),s=new $.Deferred;$.inArray(a,r)!==-1&&$.inArray(o,r)!==-1||s.reject("Invalid role!"),a===o&&s.reject("Old role and new role are the same!");var d={email:t,currentRole:a,newRole:o};return $.ajax({url:n,type:"POST",dataType:"json",data:d}).done(function(e){console.log(e),s.resolve(e)}).fail(function(e){console.log(e),s.reject(e)}),s.promise()}}(window.EC5.project_users),window.EC5=window.EC5||{},window.EC5.project_users=window.EC5.project_users||{},function(e){e.updateRoleCounters=function(){var e=$(".page-manage-users"),t=new $.Deferred,a=e.data("project-slug"),o={all:e.find(".count-overall"),creator:e.find(".nav-tabs-roles").find(".count-creator"),manager:e.find(".nav-tabs-roles").find(".count-manager"),curator:e.find(".nav-tabs-roles").find(".count-curator"),collector:e.find(".nav-tabs-roles").find(".count-collector"),viewer:e.find(".nav-tabs-roles").find(".count-viewer")},n=0;return $.when(window.EC5.project_users.getTotalsByRole(a)).then(function(e){Object.keys(o).forEach(function(t){o[t].text(e[t]),n+=e[t]||0}),o.all.text(n)}).fail(function(e){t.reject(e)}).always(function(){t.resolve()}),t.promise()}}(window.EC5.project_users),window.EC5=window.EC5||{},window.EC5.mapping=window.EC5.mapping||{},function(e){e.addMapping=function(e,t,a,o,n){t.find(".map-data__modal__mapping-name").show(),t.find(".map-data__modal-delete-warning").addClass("hidden"),t.find("map-data__modal__name-rules").removeClass("hidden"),t.find(".map-data__modal__mapping-name").val(""),a.off().on("click",function(){window.EC5.toast.clear();var a=t.find(".map-data__modal__mapping-name").val();window.EC5.projectUtils.postRequest(e,{name:a,is_default:!1}).done(function(e){console.log(e),window.EC5.toast.showSuccess(a+" mapping added");var i=e.data.map_index,r='<li role="presentation" data-map-index="'+i+'" data-map-name="'+a+'">';r+=' <a href="#map-data-tabcontent-'+i+'" role="tab" data-toggle="tab">',r+='<span class="map-data__map-name">'+a+"&nbsp;</span>",r+='<i class="fa fa-thumb-tack invisible" aria-hidden="true"></i>',r+="</a>",r+="</li>",$(".map-data__tabs li").not(".map-data__tabs__add-form").last().after(r),$.isArray(e.data.mapping)?e.data.mapping.length===o&&$(".map-data__tabs li.map-data__tabs__add-form").addClass("hidden"):Object.keys(e.data.mapping).length===o&&$(".map-data__tabs li.map-data__tabs__add-form").addClass("hidden");var s=n.find("#map-data-tabcontent-0").clone(!0,!0);s.attr("id","map-data-tabcontent-"+i),s.attr("data-map-index",i),s.attr("data-map-name",a),s.find("[data-map-index]").each(function(e,t){$(t).attr("data-map-index",i)}),s.find(".map-data--actions__btns .btn").each(function(e,t){$(t).prop("disabled",!1)}),s.find(".table-responsive").each(function(e,t){var a=$(t).find("tr td input");a.prop("disabled",!1).prop("readonly",!1)}),n.append(s),$(".map-data__tabs li.active").removeClass("active"),$('.page-mapping-data .tab-content .tab-pane[data-map-index="0"]').removeClass("active in"),$('.map-data__tabs li[data-map-index="'+i+'"]').addClass("active"),$('.map-data__tabs li[data-map-index="'+i+'"] a').tab("show"),window.setTimeout(function(){t.modal("hide")},250)}).fail(function(e){console.log(e),window.EC5.projectUtils.showErrors(e)})})}}(window.EC5.mapping),window.EC5=window.EC5||{},window.EC5.mapping=window.EC5.mapping||{},function(e){e["delete"]=function(e,t,a,o,n,i,r,s,d){i.find(".map-data__modal__mapping-name").hide(),i.find(".map-data__modal-delete-warning").removeClass("hidden"),i.find("map-data__modal__name-rules").addClass("hidden"),r.off().on("click",function(){window.EC5.toast.clear(),window.EC5.projectUtils.postRequest(e+"/delete",{map_index:a}).done(function(e){var t=$(".map-data__tabs");window.EC5.toast.showSuccess(o+" deleted"),n.remove(),d.find("#map-data-tabcontent-"+a).remove(),t.find('a[href="#map-data-tabcontent-0"]').tab("show"),s&&t.find(".map-data__default-pin").first().removeClass("invisible"),$(".map-data__tabs li.map-data__tabs__add-form").removeClass("hidden"),i.modal("hide")}).fail(function(e){console.log(e),window.EC5.projectUtils.showErrors(e)})})}}(window.EC5.mapping),window.EC5=window.EC5||{},window.EC5.mapping=window.EC5.mapping||{},function(e){e.getDefaultMapIndex=function(){var e=0,t=$(".map-data__tabs li");return t.each(function(t,a){var o=$(a).attr("data-map-index");if(!$(a).find(".map-data__default-pin").hasClass("invisible"))return e=o,!1}),parseInt(e,10)}}(window.EC5.mapping),window.EC5=window.EC5||{},window.EC5.mapping=window.EC5.mapping||{},function(e){e.makeDefault=function(e,t,a,o,n,i){window.EC5.toast.clear(),window.EC5.projectUtils.postRequest(e+"/update",{action:t,map_index:a}).done(function(e){console.log(JSON.stringify(e)),window.EC5.toast.showSuccess(o+" set as default"),n.find(".map-data__default-pin").removeClass("invisible"),i.each(function(e,t){$(t).find(".map-data__default-pin").addClass("invisible")})}).fail(function(e){window.EC5.projectUtils.showErrors(e)})}}(window.EC5.mapping),window.EC5=window.EC5||{},window.EC5.mapping=window.EC5.mapping||{},function(e){e.rename=function(e,t,a,o,n,i,r){i.find(".map-data__modal__mapping-name").show(),i.find(".map-data__modal-delete-warning").addClass("hidden"),i.find("map-data__modal__name-rules").removeClass("hidden"),i.find(".map-data__modal__mapping-name").val(o),r.off().on("click",function(){window.EC5.toast.clear();var o=i.find(".map-data__modal__mapping-name").val();window.EC5.projectUtils.postRequest(e+"/update",{action:t,map_index:a,name:o}).done(function(e){n.attr("data-map-name",o),n.find(".map-data__map-name").text(o),i.modal("hide"),window.EC5.toast.showSuccess(o+" renamed")}).fail(function(e){console.log(e),window.EC5.projectUtils.showErrors(e)})})}}(window.EC5.mapping),window.EC5=window.EC5||{},window.EC5.mapping=window.EC5.mapping||{},function(e){e.update=function(e,t,a,o){window.EC5.toast.clear(),window.EC5.overlay.fadeIn();var n={},i=$('.page-mapping-data .tab-content .tab-pane[data-map-index="'+a+'"]'),r=!0,s=null,d={},c=/^[a-zA-Z0-9_]{1,20}$/,l=/^((?![<>]).){1,150}$/,p=i.find(".panel-body .table-responsive");i.find("input").parent().removeClass("has-error"),n[a]={},n[a].name=o,n[a].forms={},n[a].map_index=a,n[a].is_default=window.EC5.mapping.getDefaultMapIndex()===a,p.each(function(e,t){var o=n[a],i=$(t).attr("data-form-ref"),p=$(t).find("tbody tr"),u=0;for(d[i]=[],o.forms[i]={};u<p.length;){var w=o.forms[i],f=$(p[u]).attr("data-input-ref"),m=$(p[u]).find(".mapping-data__map-to input"),h=m.val(),E=$(p[u]).find(".mapping-data__hide-checkbox input").is(":checked");if(h=void 0===h?void 0:h.trim(),f){switch(w[f]={},w[f].possible_answers={},w[f].branch={},w[f].group={},w[f].map_to=h,w[f].hide=E,void 0!==h&&d[i].push(h),h.match(c)||(r=!1,$(p[u]).find(".mapping-data__map-to input").parent().addClass("has-error")),$(p[u]).attr("data-input-type")){case"branch":var v=$(p[u]).nextUntil("[data-top-level-input]","[data-is-branch-input]");w[f].branch={},$(v).each(function(e,t){var a,o=$(t).attr("data-input-ref"),n=$(t).find(".mapping-data__map-to input"),s=n.val(),p=$(t).find(".mapping-data__hide-checkbox input").is(":checked");if(s=void 0===s?void 0:s.trim(),o){if(w[f].branch[o]={},a=w[f].branch[o],a.possible_answers={},a.branch={},a.group={},a.map_to=s,a.hide=p,void 0!==s&&d[i].push(s),s.match(c)||(r=!1,$(t).find(".mapping-data__map-to input").parent().addClass("has-error")),"group"===$(t).attr("data-input-type")){var m=$(t).nextUntil("[data-is-branch-input], [data-top-level-input]","[data-is-group-input]");a.group={},$(m).each(function(e,t){var n=$(t).attr("data-input-ref"),s=$(t).find(".mapping-data__map-to input"),p=s.val(),u=$(t).find(".mapping-data__hide-checkbox input").is(":checked");p=void 0===p?void 0:p.trim(),n?(a.group[n]={},a.group[n].possible_answers={},a.group[n].branch={},a.group[n].group={},a.group[n].map_to=p,a.group[n].hide=u,void 0!==p&&d[i].push(p),p.match(c)||(r=!1,$(t).find(".mapping-data__map-to input").parent().addClass("has-error"))):$(t).find(".mapping-data__possible_answer__map-to input").each(function(e,a){var n=$(t).prev().attr("data-input-ref"),i=w[f].branch[o].group[n],s=$(a).attr("data-answer-ref"),d=$(a).val();d=void 0===d?void 0:d.trim(),d.match(l)||(r=!1,$(a).parent().addClass("has-error")),i.possible_answers[s]={},i.possible_answers[s].map_to=d})}),u+=m.length}}else $(t).find(".mapping-data__possible_answer__map-to input").each(function(e,a){var o=$(t).prev().attr("data-input-ref"),n=w[f].branch[o],i=$(a).attr("data-answer-ref"),s=$(a).val();s=void 0===s?void 0:s.trim(),s.match(l)||(r=!1,$(a).parent().addClass("has-error")),n.possible_answers[i]={},n.possible_answers[i].map_to=s})}),u+=v.length;break;case"group":var C=$(p[u]).nextUntil("[data-top-level-input]","[data-is-group-input]");$(C).each(function(e,t){var a,o=$(t).attr("data-input-ref"),n=$(t).find(".mapping-data__map-to input"),s=n.val();s=void 0===s?void 0:s.trim();var p=$(t).find(".mapping-data__hide-checkbox input").is(":checked");o?(w[f].group[o]={},a=w[f].group[o],a.possible_answers={},a.branch={},a.group={},a.map_to=s,a.hide=p,void 0!==s&&d[i].push(s),s.match(c)||(r=!1,$(t).find(".mapping-data__map-to input").parent().addClass("has-error"))):$(t).find(".mapping-data__possible_answer__map-to input").each(function(e,a){var o=$(t).prev().attr("data-input-ref"),n=w[f].group[o],i=$(a).attr("data-answer-ref"),s=$(a).val();s=void 0===s?void 0:s.trim(),s.match(l)||(r=!1,$(a).parent().addClass("has-error")),n.possible_answers[i]={},n.possible_answers[i].map_to=s})}),u+=C.length}u++}else $(p[u]).find(".mapping-data__possible_answer__map-to input").each(function(e,t){var a=$(p[u-1]).attr("data-input-ref"),o=$(t).attr("data-answer-ref"),n=$(t).val();n=void 0===n?void 0:n.trim(),n.match(l)||(r=!1,$(t).parent().addClass("has-error")),w[a].possible_answers[o]={},w[a].possible_answers[o].map_to=n}),u++}console.log(JSON.stringify(d)),$.each(d,function(e,t){var a=[];$.each(t,function(t,o){return $.inArray(o.trim(),a)!==-1?(s={key:o,formRef:e},r=!1,console.log(o),!1):void a.push(o.trim())})})}),console.log(JSON.stringify(n[a])),r?window.EC5.projectUtils.postRequest(e+"/update",{action:t,map_index:a,mapping:n[a]}).done(function(e){window.EC5.overlay.fadeOut(),window.EC5.toast.showSuccess(o+" updated")}).fail(function(e){window.EC5.overlay.fadeOut(),window.EC5.projectUtils.showErrors(e)}):(s?(p.each(function(e,t){if($(t).data("form-ref")===s.formRef){var a=$(t).find("tbody tr");a.each(function(e,t){$(t).find(".mapping-data__map-to input").val()===s.key&&$(t).find(".mapping-data__map-to").addClass("has-error")})}}),window.EC5.toast.showError(o+" has got duplicate identifier: "+s.key)):window.EC5.toast.showError(o+" has got invalid identifier(s)"),window.EC5.overlay.fadeOut())}}(window.EC5.mapping);